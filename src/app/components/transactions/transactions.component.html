<div class="h-full flex flex-col space-y-3">

 <!-- Page Header with Current Balance and Lowest Points -->
 <div class="bg-white dark:bg-chatgpt-darker rounded-xl shadow-sm border border-gray-200 dark:border-chatgpt-border hover:shadow-md" style="padding: 12px">
  <div class="flex items-center justify-between">
   <div class="flex items-center space-x-6">

    <!-- Current Balance Display -->
    <div class="flex items-center space-x-2">
     <span class="text-lg font-medium text-gray-700 dark:text-chatgpt-textSecondary">Current Balance:</span>
     <button
      (click)="isEditingBalance = !isEditingBalance"
      class="text-2xl font-bold text-teal-600 dark:text-teal-400 hover:text-teal-700 dark:hover:text-teal-300 cursor-pointer">
      <span *ngIf="!isEditingBalance">${{ currentBalance | number:'1.2-2' }}</span>
      <div *ngIf="isEditingBalance" class="flex items-center space-x-2">
       <div class="relative">
        <span class="absolute left-2 top-1/2 transform -translate-y-1/2 text-gray-500 dark:text-gray-400 text-sm">$</span>
        <input
         type="number"
         name="currentBalance"
         [(ngModel)]="currentBalance"
         (blur)="updateBalance(); isEditingBalance = false"
         (keydown.enter)="updateBalance(); isEditingBalance = false"
         (keydown.escape)="isEditingBalance = false"
         class="w-36 pl-6 pr-3 py-1 text-xl font-bold border border-teal-300 dark:border-teal-600 rounded-md bg-white dark:bg-gray-800 text-teal-600 dark:text-teal-400 focus:ring-2 focus:ring-teal-500 focus:border-transparent "
         placeholder="0.00"
         step="0.01"
         #balanceInput
        >
       </div>
      </div>
     </button>
    </div>

    <!-- Lowest Points Display -->
    <div class="flex items-center space-x-2" *ngIf="getLowestProjections().length > 0">
     <span class="text-sm text-gray-500 dark:text-gray-400">Lowest Points:</span>
     <div *ngFor="let point of getLowestProjections(); let i = index"
        class="flex items-center space-x-1 px-2 py-1 rounded-full text-xs font-medium"
        [ngClass]="{
         'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300': point.balance < 0,
         'bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300': point.balance >= 0 && point.balance < currentBalance * 0.5,
         'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-300': point.balance >= currentBalance * 0.5
        }">
      <span>{{ point.label }}</span>
      <span class="font-semibold">${{ point.balance | number:'1.0-0' }}</span>
     </div>
    </div>
   </div>

   <!-- Last Updated Info -->
   <div class="flex items-center space-x-4">
    <div class="text-xs text-gray-500 dark:text-chatgpt-textSecondary">
     Last updated: {{ lastBalanceUpdate | date:'short' }}
    </div>

   </div>
  </div>
 </div>

 <!-- Transaction Timeline Section (Full Width) -->
 <div class="bg-white dark:bg-chatgpt-darker rounded-xl shadow-sm border border-gray-200 dark:border-chatgpt-border p-6 hover:shadow-md flex-1 flex flex-col">
  <!-- Header with sliding form animation -->
  <div class="relative overflow-hidden mb-2">
   <!-- Static header - title slides out, button stays in place -->
   <div class="flex items-center justify-between">
         <!-- Title that slides out when form opens -->
             <h2 class="text-xl font-semibold text-gray-900 dark:text-chatgpt-text"
       [class.transform]="showAddForm"
       [class.-translate-x-full]="showAddForm">
      {{ showViewEditMode ? 'Manage Transactions' : 'Transaction Timeline' }}
     </h2>

         <!-- Controls section -->
     <div class="flex items-center space-x-3">
      <!-- Month Picker (Grid View Only) - Moved to LEFT -->
      <div *ngIf="viewMode === 'grid' && !showViewEditMode" class="flex items-center space-x-3">
        <!-- Month/Year Display with Dropdown -->
        <div class="relative month-picker-container">
          <button
            (click)="toggleMonthPicker()"
            class="px-4 py-2 bg-teal-100 dark:bg-teal-900 hover:bg-teal-200 dark:hover:bg-teal-800 text-teal-700 dark:text-teal-300 rounded-lg text-sm font-medium transition-colors h-10 flex items-center justify-center space-x-2"
            title="Select Month"
          >
            <span>{{ getCurrentMonthLabel() }} {{ getCurrentYear() }}</span>
            <svg class="w-4 h-4 transition-transform duration-200" [class.rotate-180]="showMonthPicker" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>

          <!-- Month Picker Dropdown -->
          <div
            *ngIf="showMonthPicker"
            class="month-picker-dropdown absolute z-[99999] mt-2 left-0 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg shadow-lg overflow-hidden min-w-[280px]"
          >
            <!-- Year Navigation -->
            <div class="flex items-center justify-between p-3 border-b border-gray-200 dark:border-gray-600">
              <button
                (click)="goToPreviousYear()"
                class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors"
                title="Previous Year"
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path d="M15 19l-7-7 7-7"></path>
                </svg>
              </button>
              <span class="text-lg font-semibold text-gray-900 dark:text-white">{{ getCurrentYear() }}</span>
              <button
                (click)="goToNextYear()"
                class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors"
                title="Next Year"
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path d="M9 5l7 7-7 7"></path>
                </svg>
              </button>
            </div>

            <!-- Month Grid -->
            <div class="p-3">
              <div class="grid grid-cols-3 gap-2">
                <button
                  *ngFor="let month of monthOptions"
                  (click)="selectMonth(month.value)"
                  class="px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-teal-50 dark:hover:bg-teal-900/20 rounded-md transition-colors"
                  [ngClass]="{
                    'bg-teal-100 text-teal-700 dark:bg-teal-900/30 dark:text-teal-300': month.value === currentViewMonth.getMonth()
                  }">
                  {{ month.label }}
                </button>
              </div>
            </div>

            <!-- Quick Actions -->
            <div class="p-3 border-t border-gray-200 dark:border-gray-600">
              <button
                (click)="goToCurrentMonth(); showMonthPicker = false"
                class="w-full px-3 py-2 text-sm text-teal-600 dark:text-teal-400 hover:bg-teal-50 dark:hover:bg-teal-900/20 rounded-md transition-colors">
                Go to Current Month
              </button>
            </div>
          </div>
        </div>

        <span class="text-xs text-gray-500 dark:text-gray-400 px-2 py-2 h-10 flex items-center">
          (Showing {{ getCurrentMonthLabel() }} {{ getCurrentYear() }} + 2 months)
        </span>
      </div>

      <!-- Add Transaction Button -->
      <button
        (click)="toggleAddForm()"
        class="px-4 py-2 bg-chatgpt-accent hover:bg-chatgpt-accentHover text-white font-medium rounded-lg focus:ring-2 focus:ring-chatgpt-accent focus:ring-offset-2 shadow-lg hover:shadow-xl relative z-10"
        [class.bg-red-500]="showAddForm"
        [class.hover:bg-red-600]="showAddForm"
      >
        {{ showAddForm ? 'Cancel' : '+ Add Transaction' }}
      </button>

      <!-- View/Edit Transactions Toggle -->
      <button
        (click)="toggleViewEditMode()"
        class="px-4 py-2 bg-teal-600 hover:bg-teal-700 text-white font-medium rounded-lg focus:ring-2 focus:ring-teal-500 focus:ring-offset-2 shadow-lg hover:shadow-xl transition-colors duration-200"
        [class.bg-orange-500]="showViewEditMode"
        [class.hover:bg-orange-600]="showViewEditMode"
      >
        {{ showViewEditMode ? 'Back to Calendar' : 'View/Edit Transactions' }}
      </button>

      <!-- View Mode Toggle -->
      <div *ngIf="!showViewEditMode" class="flex items-center bg-gray-100 dark:bg-gray-800 rounded-lg p-1 shadow-inner">
        <button
          (click)="toggleViewMode()"
          class="flex items-center justify-center w-8 h-8 rounded-md relative group"
          [class.bg-white]="viewMode === 'grid'"
          [class.shadow-sm]="viewMode === 'grid'"
          [class.text-teal-600]="viewMode === 'grid'"
          [class.text-gray-500]="viewMode !== 'grid'"
          [class.hover:text-teal-500]="viewMode !== 'grid'"
          title="Grid View"
        >
          <!-- Grid Icon -->
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/>
          </svg>
        </button>
        <button
          (click)="toggleViewMode()"
          class="flex items-center justify-center w-8 h-8 rounded-md relative group"
          [class.bg-white]="viewMode === 'list'"
          [class.shadow-sm]="viewMode === 'list'"
          [class.text-teal-600]="viewMode === 'list'"
          [class.text-gray-500]="viewMode !== 'list'"
          [class.hover:text-teal-500]="viewMode !== 'list'"
          title="List View"
        >
          <!-- List Icon -->
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"/>
          </svg>
        </button>
      </div>
     </div>
   </div>

   <!-- Custom Modal for Add Transaction -->
   <app-custom-modal
     [isOpen]="showAddForm"
     title="Add Recurring Transaction"
     size="lg"
     (closeModal)="toggleAddForm()"
   >
     <!-- Modal Content -->
     <div class="space-y-4">
       <!-- Status Messages -->
       <div *ngIf="saveError" class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-3">
         <div class="flex items-center">
           <svg class="w-5 h-5 text-red-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
             <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
           </svg>
           <span class="text-red-800 dark:text-red-200 text-sm">{{ saveError }}</span>
         </div>
       </div>
       
       <div *ngIf="saveSuccess" class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-3">
         <div class="flex items-center">
           <svg class="w-5 h-5 text-green-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
             <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
           </svg>
           <span class="text-green-800 dark:text-green-200 text-sm">Transaction saved successfully!</span>
         </div>
       </div>
       
       <!-- Description and Amount row -->
       <div class="grid grid-cols-2 gap-4">
         <div>
           <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Description</label>
           <input
             #descriptionInput
             type="text"
             name="description"
             [(ngModel)]="newRecurringTransaction.description"
             (keydown.enter)="addRecurringTransaction()"
             (blur)="validateForm()"
             [class]="hasFieldError('description') 
               ? 'w-full px-3 py-2 border border-red-500 dark:border-red-400 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-red-500 focus:border-transparent'
               : 'w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-teal-500 focus:border-transparent'"
             placeholder="Transaction description"
           >
           <div *ngIf="hasFieldError('description')" class="mt-1 text-sm text-red-600 dark:text-red-400">
             {{ getFieldError('description') }}
           </div>
         </div>
         <div>
           <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Amount</label>
           <div class="relative">
             <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 dark:text-gray-400">$</span>
             <input
               type="number"
               name="amount"
               [(ngModel)]="newRecurringTransaction.amount"
               (keydown.enter)="addRecurringTransaction()"
               (blur)="validateForm()"
               [class]="hasFieldError('amount') 
                 ? 'w-full pl-8 pr-3 py-2 border border-red-500 dark:border-red-400 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-red-500 focus:border-transparent'
                 : 'w-full pl-8 pr-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-teal-500 focus:border-transparent'"
               placeholder="0.00"
               step="0.01"
             >
           </div>
           <div *ngIf="hasFieldError('amount')" class="mt-1 text-sm text-red-600 dark:text-red-400">
             {{ getFieldError('amount') }}
           </div>
         </div>
       </div>

       <!-- Type and Category row -->
       <div class="grid grid-cols-2 gap-4">
         <div>
           <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Type</label>
           <app-custom-dropdown
             [options]="transactionTypeOptions"
             [(selectedValue)]="newRecurringTransaction.type"
             placeholder="Select type"
             size="md"
             variant="outline"
           ></app-custom-dropdown>
         </div>
         <div>
           <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Category</label>
           <app-custom-dropdown
             [options]="categoryOptions"
             [(selectedValue)]="newRecurringTransaction.category"
             placeholder="Select category"
             size="md"
             variant="outline"
             [allowAdd]="true"
             (optionAdded)="onCategoryAdded($event)"
             (selectionChange)="validateForm()"
           ></app-custom-dropdown>
           <div *ngIf="hasFieldError('category')" class="mt-1 text-sm text-red-600 dark:text-red-400">
             {{ getFieldError('category') }}
           </div>
         </div>
       </div>

       <!-- Start Date, End Date, and Frequency row -->
       <div class="grid grid-cols-2 gap-4">
         <div class="flex space-x-2">
           <div class="flex-1 start-date-container">
             <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Start Date</label>
             <div class="relative">
               <input
                 type="text"
                 name="startDateString"
                 [(ngModel)]="startDateString"
                 (click)="toggleDatePicker()"
                 readonly
                 [class]="hasFieldError('date') 
                   ? 'w-full px-3 py-2 border border-red-500 dark:border-red-400 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-red-500 focus:border-transparent cursor-pointer'
                   : 'w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-teal-500 focus:border-transparent cursor-pointer'"
                 placeholder="start date"
               >
               <div class="absolute right-3 top-1/2 transform -translate-y-1/2 flex items-center space-x-1">
                 <button
                   *ngIf="startDateString"
                   (click)="clearStartDate()"
                   type="button"
                   class="w-4 h-4 text-gray-400 hover:text-red-500 transition-colors"
                   title="Clear start date"
                 >
                   <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                   </svg>
                 </button>
                 <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                   <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 002 2z"></path>
                 </svg>
               </div>
             </div>
             <ngb-datepicker
               #startDatePicker
               name="startDate"
               [(ngModel)]="startDate"
               (ngModelChange)="onStartDateChange($event)"
               (click)="onDatePickerClick($event)"
               [class.hidden]="!showDatePicker"
               class="absolute z-50 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg shadow-lg mt-1 overflow-hidden"
             ></ngb-datepicker>
             <div *ngIf="hasFieldError('date')" class="mt-1 text-sm text-red-600 dark:text-red-400">
               {{ getFieldError('date') }}
             </div>
           </div>
           <div class="flex-1 end-date-container">
             <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">End Date (Optional)</label>
             <div class="relative">
               <input
                 type="text"
                 name="endDateString"
                 [(ngModel)]="endDateString"
                 (click)="toggleEndDatePicker()"
                 readonly
                 class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-teal-500 focus:border-transparent cursor-pointer"
                                   placeholder="end date"
               >
               <div class="absolute right-3 top-1/2 transform -translate-y-1/2 flex items-center space-x-1">
                 <button
                   *ngIf="endDateString"
                   (click)="clearEndDate()"
                   type="button"
                   class="w-4 h-4 text-gray-400 hover:text-red-500 transition-colors"
                   title="Clear end date"
                 >
                   <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                   </svg>
                 </button>
                 <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                   <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 002 2z"></path>
                 </svg>
               </div>
             </div>
             <ngb-datepicker
               #endDatePicker
               name="endDate"
               [(ngModel)]="endDate"
               (ngModelChange)="onEndDateChange($event)"
               (click)="onDatePickerClick($event)"
               [class.hidden]="!showEndDatePicker"
               class="absolute z-50 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg shadow-lg mt-1 overflow-hidden"
             ></ngb-datepicker>
           </div>
         </div>
         <div>
           <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Frequency</label>
           <app-custom-dropdown
             [options]="frequencyOptions"
             [(selectedValue)]="newRecurringTransaction.recurringPattern!.frequency"
             placeholder="Select frequency"
             size="md"
             variant="outline"
           ></app-custom-dropdown>

            <!-- Monthly options checkboxes - directly under frequency input -->
            <div [class.hidden]="newRecurringTransaction.recurringPattern!.frequency !== RecurrenceFrequency.MONTHLY" class="mt-2 space-y-3">
              <div class="flex items-center space-x-4">
                <label class="flex items-center cursor-pointer">
                  <input
                    type="checkbox"
                    [checked]="newRecurringTransaction.recurringPattern!.lastDayOfMonth ?? false"
                    (change)="onLastDayOptionChange('lastDay', $event)"
                    class="w-4 h-4 text-teal-600 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-500 rounded focus:ring-teal-500 dark:focus:ring-teal-600 focus:ring-2 mr-2"
                  >
                  <span class="text-sm text-gray-700 dark:text-gray-300">Last day</span>
                </label>
                <label class="flex items-center cursor-pointer">
                  <input
                    type="checkbox"
                    [checked]="newRecurringTransaction.recurringPattern!.lastWeekdayOfMonth ?? false"
                    (change)="onLastDayOptionChange('lastWeekday', $event)"
                    class="w-4 h-4 text-teal-600 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-500 rounded focus:ring-teal-500 dark:focus:ring-teal-600 focus:ring-2 mr-2"
                  >
                  <span class="text-sm text-gray-700 dark:text-gray-300">Last weekday</span>
                </label>
              </div>
            </div>
         </div>
       </div>

       <!-- Submit button -->
       <div class="flex justify-end space-x-3 pt-4">
         <button
           (click)="toggleAddForm()"
           class="px-6 py-2 bg-gray-500 hover:bg-gray-600 text-white font-medium rounded-lg focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 shadow-sm hover:shadow-md transition-colors duration-200"
         >
           Cancel
         </button>
         <button
           (click)="addRecurringTransaction()"
           [disabled]="!isFormValid || isSaving"
           [class]="getSaveButtonClasses()"
         >
           <span *ngIf="!isSaving && !saveSuccess">Add Transaction</span>
           <span *ngIf="isSaving" class="flex items-center">
             <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
               <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
               <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
             </svg>
             Saving...
           </span>
           <span *ngIf="saveSuccess" class="flex items-center">
             <svg class="w-4 h-4 mr-2 text-white" fill="currentColor" viewBox="0 0 20 20">
               <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
             </svg>
             Saved!
           </span>
         </button>
       </div>
     </div>
   </app-custom-modal>

                                                                                               <!-- Timeline Items - Conditional View -->
                            <div *ngIf="!showViewEditMode" id="views-container" class="flex-1 overflow-y-auto mt-2 border border-gray-200 dark:border-chatgpt-border rounded-md p-2 overflow-x-hidden" style="max-height: 500px;">

                                                                <!-- Grid View (Current Calendar Layout) -->
                <div [class.hidden]="viewMode !== 'grid'" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-2 grid-aligned-with-toggle w-full max-w-full overflow-hidden">
    <div *ngFor="let group of getGroupedTransactions()" class="border border-gray-200 dark:border-chatgpt-border rounded-md overflow-hidden bg-white dark:bg-chatgpt-darker hover:shadow-md">
     <!-- Date Header - More Compact -->
     <div class="bg-gray-100 dark:bg-chatgpt-light px-2 py-1 border-b border-gray-200 dark:border-chatgpt-border">
      <div class="flex items-center justify-between">
       <!-- Left: Month -->
       <div class="text-xs font-medium text-gray-500 dark:text-gray-400 leading-none">
        {{ group.date | date:'MMM' }}
       </div>
       <!-- Center: Date & Day -->
       <div class="text-center">
        <div class="font-bold text-teal-600 dark:text-teal-400 text-sm leading-none">{{ group.date | date:'d' }}</div>
        <div class="font-medium text-gray-600 dark:text-gray-300 text-xs leading-none">{{ group.date | date:'EEE' }}</div>
       </div>
       <!-- Right: Spacer for balance -->
       <div class="text-xs w-8"></div>
      </div>
     </div>

           <!-- Transactions in this date card - More Compact -->
      <div class="p-1.5 space-y-1 min-h-[90px] max-h-[120px] overflow-y-auto">
             <div *ngFor="let transaction of group.transactions; let transactionIndex = index"
          class="group rounded px-1.5 py-1"
          [class.bg-white]="transactionIndex % 2 === 0"
          [class.bg-gray-50]="transactionIndex % 2 !== 0"
          [class.dark:bg-chatgpt-darker]="transactionIndex % 2 === 0"
          [class.dark:bg-chatgpt-light]="transactionIndex % 2 !== 0"
          [class.hover:bg-gray-100]="transactionIndex % 2 === 0"
          [class.hover:bg-gray-200]="transactionIndex % 2 !== 0"
          [class.dark:hover:bg-gray-800]="transactionIndex % 2 === 0"
          [class.dark:hover:bg-gray-700]="transactionIndex % 2 !== 0">

       <!-- Single Line Layout -->
       <div class="flex items-center justify-between">
        <!-- Left: Description -->
        <div class="flex-1 min-w-0">
         <div class="font-medium text-gray-900 dark:text-gray-100 truncate text-xs leading-tight">{{ transaction.description }}</div>
        </div>

        <!-- Right: Amount + Delete -->
        <div class="flex items-center space-x-1 flex-shrink-0">
                    <div class="font-medium text-xs" [ngClass]="{
            'text-red-600 dark:text-red-400': transaction.type === TransactionType.EXPENSE,
            'text-chatgpt-accent dark:text-chatgpt-accent': transaction.type === TransactionType.INCOME
           }">
          {{ transaction.type === TransactionType.EXPENSE ? '-' : '+' }}${{ transaction.amount | number:'1.0-0' }}
         </div>
         <button
          (click)="deleteTransaction(transaction.id)"
          class="opacity-0 group-hover:opacity-100 text-gray-400 hover:text-red-500 w-3 h-3 flex items-center justify-center"
          title="Delete"
         >
          ×
         </button>
        </div>
       </div>
      </div>

      <!-- Empty state for cards with no transactions -->
      <div *ngIf="group.transactions.length === 0" class="text-center py-2 text-gray-400 dark:text-gray-500 text-xs">
       No transactions
      </div>
     </div>
    </div>
   </div>

                               <!-- List View (New Compact Layout) -->
      <div [class.hidden]="viewMode !== 'list'" class="border border-gray-200 dark:border-chatgpt-border rounded-lg overflow-hidden flex flex-col h-96 w-full max-w-full">
        <!-- Fixed Header Row -->
        <div class="bg-gray-100 dark:bg-chatgpt-light px-4 py-2 border-b border-gray-200 dark:border-chatgpt-border">
         <div class="flex items-center justify-between text-xs font-medium text-gray-600 dark:text-gray-400">
          <div class="flex-1">Description</div>
          <div class="w-20 text-center">Date</div>
          <div class="w-24 text-center">Category</div>
          <div class="w-20 text-right">Amount</div>
          <div class="w-16 text-center">Frequency</div>
          <div class="w-8"></div>
         </div>
        </div>

    <!-- Scrollable Transaction Rows Container -->
    <div class="flex-1 overflow-y-auto">
     <div>
      <div *ngFor="let group of getGroupedTransactions(); let groupIndex = index">
               <div *ngFor="let transaction of group.transactions; let transactionIndex = index"
           class="px-4 py-1.5 group"
           [class.bg-white]="isEvenRow(groupIndex, transactionIndex)"
           [class.bg-gray-100]="!isEvenRow(groupIndex, transactionIndex)"
           [class.dark:bg-chatgpt-darker]="isEvenRow(groupIndex, transactionIndex)"
           [class.dark:bg-chatgpt-light]="!isEvenRow(groupIndex, transactionIndex)"
           [class.hover:bg-gray-100]="isEvenRow(groupIndex, transactionIndex)"
           [class.hover:bg-gray-200]="!isEvenRow(groupIndex, transactionIndex)"
           [class.dark:hover:bg-gray-800]="isEvenRow(groupIndex, transactionIndex)"
           [class.dark:hover:bg-gray-700]="!isEvenRow(groupIndex, transactionIndex)">
        <div class="flex items-center justify-between">

         <!-- Description -->
         <div class="flex-1 min-w-0">
          <div class="font-medium text-gray-900 dark:text-gray-100 truncate text-sm leading-tight">
           {{ transaction.description }}
          </div>
         </div>

         <!-- Date -->
         <div class="w-20 text-center">
          <div class="text-xs text-gray-500 dark:text-gray-400">
           {{ transaction.date | date:'MMM d' }}
          </div>
         </div>

                   <!-- Category -->
          <div class="w-24 text-center">
           <span class="inline-flex items-center px-1.5 py-0.5 rounded-full text-xs font-medium bg-teal-50 dark:bg-teal-900/30 text-teal-700 dark:text-teal-300">
            {{ transaction.category }}
           </span>
          </div>

                   <!-- Amount -->
          <div class="w-20 text-right">
           <div class="font-semibold text-sm" [ngClass]="{
            'text-red-600 dark:text-red-400': transaction.type === TransactionType.EXPENSE,
            'text-chatgpt-accent dark:text-chatgpt-accent': transaction.type === TransactionType.INCOME
           }">
           {{ transaction.type === TransactionType.EXPENSE ? '-' : '+' }}${{ transaction.amount | number:'1.0-0' }}
          </div>
         </div>

         <!-- Frequency -->
         <div class="w-16 text-center">
          <div class="text-xs text-gray-500 dark:text-gray-400 capitalize">
           {{ transaction.recurringPattern?.frequency?.toLowerCase() || 'Once' }}
          </div>
         </div>

         <!-- Delete Button -->
         <div class="w-8 flex justify-center">
          <button
           (click)="deleteTransaction(transaction.id)"
           class="opacity-0 group-hover:opacity-100 w-5 h-5 flex items-center justify-center text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded "
           title="Delete Transaction"
          >
           <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
           </svg>
          </button>
         </div>

        </div>
       </div>
      </div>
     </div>
    </div>
   </div>

       <!-- Empty State -->
    <div *ngIf="getGroupedTransactions().length === 0" class="text-center py-8">
     <div class="text-gray-500 dark:text-chatgpt-textSecondary">
      <div class="mb-2">No transactions found for {{ getCurrentMonthLabel() }} {{ getCurrentYear() }} + 2 months</div>
      <div class="text-sm">Add recurring transactions to see your timeline</div>
      <div class="text-xs mt-1">Recurring transactions will appear in all months after their starting date</div>
     </div>
    </div>
   </div>

       <!-- View/Edit Transactions Component -->
    <div *ngIf="showViewEditMode" class="border border-gray-200 dark:border-chatgpt-border rounded-lg overflow-hidden bg-white dark:bg-chatgpt-darker mt-2 view-edit-transactions">
      <!-- Header Row -->
      <div class="bg-gray-100 dark:bg-chatgpt-light px-4 py-2 border-b border-gray-200 dark:border-chatgpt-border">
        <div class="flex items-center justify-between text-xs font-medium text-gray-600 dark:text-gray-400">
          <div class="w-20">Date</div>
          <div class="flex-1">Description</div>
          <div class="w-36">Category</div>
          <div class="w-20 text-right">Amount</div>
          <div class="w-20 text-center">Frequency</div>
          <div class="w-20 text-center">Actions</div>
        </div>
      </div>

      <!-- Transactions List -->
      <div class="max-h-96 overflow-y-auto">
        <div *ngFor="let transaction of getDatabaseTransactions(); let transactionIndex = index"
             class="px-4 py-2 transition-colors duration-150 transaction-row"
             [ngClass]="{
               'even-row': transactionIndex % 2 === 0,
               'odd-row': transactionIndex % 2 !== 0
             }">

                       <!-- Transaction Row -->
            <div class="flex items-center space-x-3">
              <!-- Date -->
              <div class="w-20 flex-shrink-0">
                <div class="text-sm font-medium text-gray-900 dark:text-chatgpt-text">
                  {{ transaction.date | date:'MMM d' }}
                </div>
                <div class="text-xs text-gray-500 dark:text-gray-400">
                  {{ transaction.date | date:'EEE' }}
                </div>
              </div>

             <!-- Description -->
             <div class="flex-1 min-w-0">
               <div *ngIf="!transaction.isEditing" 
                    class="text-sm font-medium text-gray-900 dark:text-chatgpt-text truncate cursor-pointer hover:text-teal-600 dark:hover:text-teal-400 editable-field"
                    (click)="startEditing(transaction)">
                 {{ transaction.description }}
               </div>
               <input *ngIf="transaction.isEditing"
                      type="text"
                      [(ngModel)]="transaction.description"
                      (blur)="saveTransaction(transaction)"
                      (keydown.enter)="saveTransaction(transaction)"
                      (keydown.escape)="cancelEditing(transaction)"
                      class="w-full px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-900 dark:text-chatgpt-text focus:ring-2 focus:ring-teal-500 focus:border-transparent transition-all duration-200"
                      placeholder="Enter description">
             </div>

             <!-- Category (Dropdown) -->
              <div class="w-36 flex-shrink-0">
                <app-custom-dropdown
                  [options]="categoryOptions"
                  [(selectedValue)]="transaction.category"
                  placeholder="Select category"
                  size="sm"
                  variant="outline"
                  [allowAdd]="true"
                  (optionAdded)="onCategoryAdded($event)"
                  (selectedValueChange)="onCategoryChange(transaction, $event)"
                ></app-custom-dropdown>
              </div>

             <!-- Amount -->
              <div class="w-20 flex-shrink-0">
                <div *ngIf="!transaction.isEditing" 
                     class="text-sm font-semibold cursor-pointer hover:text-teal-600 dark:hover:text-teal-400 transition-colors duration-200 editable-field"
                     [ngClass]="{
                       'text-red-600 dark:text-red-400': transaction.type === TransactionType.EXPENSE,
                       'text-chatgpt-accent dark:text-chatgpt-accent': transaction.type === TransactionType.INCOME
                     }"
                     (click)="startEditing(transaction)">
                                    {{ transaction.type === TransactionType.EXPENSE ? '-' : '+' }}${{ transaction.amount | number:'1.0-0' }}
                <!-- Debug: {{ transaction.type }} | {{ transaction.amount }} -->
                  <!-- Debug: {{ transaction.type }} | {{ transaction.amount }} -->
                </div>
                <input *ngIf="transaction.isEditing"
                       type="number"
                       [(ngModel)]="transaction.amount"
                       (blur)="saveTransaction(transaction)"
                       (keydown.enter)="saveTransaction(transaction)"
                       (keydown.escape)="cancelEditing(transaction)"
                       class="w-full px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-900 dark:text-chatgpt-text focus:ring-2 focus:ring-teal-500 focus:border-transparent transition-all duration-200"
                       placeholder="0.00"
                       step="0.01">
              </div>

             <!-- Frequency -->
             <div class="w-20 flex-shrink-0">
               <span class="text-xs text-gray-500 dark:text-gray-400 capitalize">
                 {{ transaction.recurringPattern?.frequency?.toLowerCase() || 'Once' }}
               </span>
             </div>

             <!-- Actions -->
             <div class="w-20 flex-shrink-0 flex items-center space-x-2">
               <!-- Edit Button (shown when not editing) -->
               <button
                 (click)="startEditing(transaction)"
                 class="p-1.5 text-gray-400 hover:text-teal-600 dark:hover:text-teal-400 hover:bg-teal-50 dark:hover:bg-teal-900/20 rounded-md transition-colors"
                 title="Edit transaction"
                 [class.hidden]="transaction.isEditing"
               >
                 <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                   <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                 </svg>
               </button>
               
               <!-- Save Button (shown when editing) -->
               <button
                 *ngIf="transaction.isEditing"
                 (click)="saveTransaction(transaction)"
                 class="p-1.5 text-green-600 hover:text-green-700 dark:text-green-400 dark:hover:text-green-300 hover:bg-green-50 dark:hover:bg-green-900/20 rounded-md transition-colors"
                 title="Save changes"
               >
                 <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                   <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                 </svg>
               </button>
               
               <!-- Cancel Button (shown when editing) -->
               <button
                 *ngIf="transaction.isEditing"
                 (click)="cancelEditing(transaction)"
                 class="p-1.5 text-gray-600 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-900/20 rounded-md transition-colors"
                 title="Cancel editing"
               >
                 <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                   <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                 </svg>
               </button>
               
               <!-- Delete Button -->
               <button
                 (click)="deleteTransactionFromDatabase(transaction.id)"
                 class="p-1.5 text-gray-400 hover:text-red-600 dark:hover:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-md transition-colors"
                 title="Delete transaction"
               >
                 <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                   <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                 </svg>
               </button>
             </div>
           </div>
         </div>
       </div>
     </div>

     <!-- Empty State for View/Edit Mode -->
     <div *ngIf="getDatabaseTransactions().length === 0" class="text-center py-12">
       <div class="text-gray-500 dark:text-chatgpt-textSecondary">
         <svg class="mx-auto h-12 w-12 text-gray-400 dark:text-gray-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 00-2 2v2h2V5z"/>
         </svg>
         <p class="text-lg font-medium">No transactions found</p>
         <p class="text-sm">No transactions exist in the database yet</p>
       </div>
     </div>
   </div>
  </div>

 <!-- Bottom Row: Balance Projection Chart (Full Width) -->
 <div class="mt-3">
  <app-balance-projection-chart
   [timeline]="timeline"
   [projectionInterval]="projectionInterval"
   [currentBalance]="currentBalance"
   (intervalChange)="onProjectionIntervalChange($event)">
  </app-balance-projection-chart>
 </div>
</div>
