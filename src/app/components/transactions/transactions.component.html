<div class="h-full flex flex-col space-y-3">

 <!-- Page Header with Current Balance and Lowest Points -->
 <div class="bg-white dark:bg-chatgpt-darker rounded-xl shadow-sm border border-gray-200 dark:border-chatgpt-border hover:shadow-md" style="padding: 12px">
  <div class="flex items-center justify-between">
   <div class="flex items-center space-x-6">

    <!-- Current Balance Display -->
    <div class="flex items-center space-x-2">
     <span class="text-lg font-medium text-gray-700 dark:text-chatgpt-textSecondary">Current Balance:</span>
     <button
      (click)="isEditingBalance = !isEditingBalance"
      class="text-2xl font-bold text-teal-600 dark:text-teal-400 hover:text-teal-700 dark:hover:text-teal-300 cursor-pointer">
      <span *ngIf="!isEditingBalance">${{ currentBalance | number:'1.2-2' }}</span>
      <div *ngIf="isEditingBalance" class="flex items-center space-x-2">
       <div class="relative">
        <span class="absolute left-2 top-1/2 transform -translate-y-1/2 text-gray-500 dark:text-gray-400 text-sm">$</span>
        <input
         type="number"
         [(ngModel)]="currentBalance"
         (blur)="updateBalance(); isEditingBalance = false"
         (keydown.enter)="updateBalance(); isEditingBalance = false"
         (keydown.escape)="isEditingBalance = false"
         class="w-36 pl-6 pr-3 py-1 text-xl font-bold border border-teal-300 dark:border-teal-600 rounded-md bg-white dark:bg-gray-800 text-teal-600 dark:text-teal-400 focus:ring-2 focus:ring-teal-500 focus:border-transparent "
         placeholder="0.00"
         step="0.01"
         #balanceInput
        >
       </div>
      </div>
     </button>
    </div>

    <!-- Lowest Points Display -->
    <div class="flex items-center space-x-2" *ngIf="getLowestProjections().length > 0">
     <span class="text-sm text-gray-500 dark:text-gray-400">Lowest Points:</span>
     <div *ngFor="let point of getLowestProjections(); let i = index"
        class="flex items-center space-x-1 px-2 py-1 rounded-full text-xs font-medium"
        [ngClass]="{
         'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300': point.balance < 0,
         'bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300': point.balance >= 0 && point.balance < currentBalance * 0.5,
         'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-300': point.balance >= currentBalance * 0.5
        }">
      <span>{{ point.label }}</span>
      <span class="font-semibold">${{ point.balance | number:'1.0-0' }}</span>
     </div>
    </div>
   </div>

   <!-- Last Updated Info -->
   <div class="flex items-center space-x-4">
    <div class="text-xs text-gray-500 dark:text-chatgpt-textSecondary">
     Last updated: {{ lastBalanceUpdate | date:'short' }}
    </div>
    <!-- Debug button - remove in production -->
    <button
     (click)="clearDataAndReload()"
     class="px-2 py-1 text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 rounded border"
     title="Clear data and reload sample transactions (debug)"
    >
     Reset Data
    </button>
   </div>
  </div>
 </div>

 <!-- Transaction Timeline Section (Full Width) -->
 <div class="bg-white dark:bg-chatgpt-darker rounded-xl shadow-sm border border-gray-200 dark:border-chatgpt-border p-6 hover:shadow-md flex-1 flex flex-col overflow-hidden">
  <!-- Header with sliding form animation -->
  <div class="relative overflow-hidden mb-2">
   <!-- Static header - title slides out, button stays in place -->
   <div class="flex items-center justify-between">
    <!-- Title that slides out when form opens -->
            <h2 class="text-xl font-semibold text-gray-900 dark:text-chatgpt-text"
      [class.transform]="showAddForm"
      [class.-translate-x-full]="showAddForm">
     Transaction Timeline
    </h2>

    <!-- Controls section -->
    <div class="flex items-center space-x-3">
     <!-- Add Transaction Button -->
     <button
      (click)="toggleAddForm()"
                  class="px-4 py-2 bg-chatgpt-accent hover:bg-chatgpt-accentHover text-white font-medium rounded-lg focus:ring-2 focus:ring-chatgpt-accent focus:ring-offset-2 shadow-lg hover:shadow-xl relative z-10"
      [class.bg-red-500]="showAddForm"
      [class.hover:bg-red-600]="showAddForm"
     >
      {{ showAddForm ? 'Cancel' : '+ Add Transaction' }}
     </button>

     <!-- View Mode Toggle -->
     <div class="flex items-center bg-gray-100 dark:bg-gray-800 rounded-lg p-1 shadow-inner">
      <button
       (click)="toggleViewMode()"
                     class="flex items-center justify-center w-8 h-8 rounded-md relative group"
       [class.bg-white]="viewMode === 'grid'"
       [class.shadow-sm]="viewMode === 'grid'"
       [class.text-teal-600]="viewMode === 'grid'"
       [class.text-gray-500]="viewMode !== 'grid'"
       [class.hover:text-teal-500]="viewMode !== 'grid'"
       title="Grid View"
      >
       <!-- Grid Icon -->
       <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
        <path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/>
       </svg>
      </button>
      <button
       (click)="toggleViewMode()"
                     class="flex items-center justify-center w-8 h-8 rounded-md relative group"
       [class.bg-white]="viewMode === 'list'"
       [class.shadow-sm]="viewMode === 'list'"
       [class.text-teal-600]="viewMode === 'list'"
       [class.text-gray-500]="viewMode !== 'list'"
       [class.hover:text-teal-500]="viewMode !== 'list'"
       title="List View"
      >
       <!-- List Icon -->
       <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"/>
       </svg>
      </button>
     </div>
    </div>
   </div>

   <!-- Custom Modal for Add Transaction -->
   <app-custom-modal
     [isOpen]="showAddForm"
     title="Add Recurring Transaction"
     size="lg"
     (closeModal)="toggleAddForm()"
   >
     <!-- Modal Content -->
     <div class="space-y-4">
       <!-- Description and Amount row -->
       <div class="grid grid-cols-2 gap-4">
         <div>
           <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Description</label>
           <input
             #descriptionInput
             type="text"
             [(ngModel)]="newRecurringTransaction.description"
             (keydown.enter)="addRecurringTransaction()"
             class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-teal-500 focus:border-transparent"
             placeholder="Transaction description"
           >
         </div>
         <div>
           <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Amount</label>
           <div class="relative">
             <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 dark:text-gray-400">$</span>
             <input
               type="number"
               [(ngModel)]="newRecurringTransaction.amount"
               (keydown.enter)="addRecurringTransaction()"
               class="w-full pl-8 pr-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-teal-500 focus:border-transparent"
               placeholder="0.00"
               step="0.01"
             >
           </div>
         </div>
       </div>

       <!-- Type and Category row -->
       <div class="grid grid-cols-2 gap-4">
         <div>
           <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Type</label>
           <app-custom-dropdown
             [options]="transactionTypeOptions"
             [(selectedValue)]="newRecurringTransaction.type"
             placeholder="Select type"
             size="md"
             variant="outline"
           ></app-custom-dropdown>
         </div>
         <div>
           <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Category</label>
           <input
             type="text"
             [(ngModel)]="newRecurringTransaction.category"
             (keydown.enter)="addRecurringTransaction()"
             class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-teal-500 focus:border-transparent"
             placeholder="Category"
           >
         </div>
       </div>

       <!-- Start Date, End Date, and Frequency row -->
       <div class="grid grid-cols-2 gap-4">
         <div class="flex space-x-2">
           <div class="flex-1">
             <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Start Date</label>
             <div class="relative">
               <input
                 type="text"
                 [(ngModel)]="startDateString"
                 (click)="toggleDatePicker()"
                 readonly
                 class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-teal-500 focus:border-transparent cursor-pointer"
                                   placeholder="start date"
               >
               <div class="absolute right-3 top-1/2 transform -translate-y-1/2 flex items-center space-x-1">
                 <button
                   *ngIf="startDateString"
                   (click)="clearStartDate()"
                   type="button"
                   class="w-4 h-4 text-gray-400 hover:text-red-500 transition-colors"
                   title="Clear start date"
                 >
                   <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                   </svg>
                 </button>
                 <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                   <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 002 2z"></path>
                 </svg>
               </div>
             </div>
             <ngb-datepicker 
               #startDatePicker
               [(ngModel)]="startDate"
               (ngModelChange)="onStartDateChange($event)"
               [class.hidden]="!showDatePicker"
               class="absolute z-50 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg shadow-lg mt-1"
             ></ngb-datepicker>
           </div>
           <div class="flex-1">
             <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">End Date (Optional)</label>
             <div class="relative">
               <input
                 type="text"
                 [(ngModel)]="endDateString"
                 (click)="toggleEndDatePicker()"
                 readonly
                 class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-teal-500 focus:border-transparent cursor-pointer"
                                   placeholder="end date"
               >
               <div class="absolute right-3 top-1/2 transform -translate-y-1/2 flex items-center space-x-1">
                 <button
                   *ngIf="endDateString"
                   (click)="clearEndDate()"
                   type="button"
                   class="w-4 h-4 text-gray-400 hover:text-red-500 transition-colors"
                   title="Clear end date"
                 >
                   <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                   </svg>
                 </button>
                 <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                   <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 002 2z"></path>
                 </svg>
               </div>
             </div>
             <ngb-datepicker 
               #endDatePicker
               [(ngModel)]="endDate"
               (ngModelChange)="onEndDateChange($event)"
               [class.hidden]="!showEndDatePicker"
               class="absolute z-50 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg shadow-lg mt-1"
             ></ngb-datepicker>
           </div>
         </div>
         <div>
           <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Frequency</label>
           <app-custom-dropdown
             [options]="frequencyOptions"
             [(selectedValue)]="newRecurringTransaction.recurringPattern!.frequency"
             placeholder="Select frequency"
             size="md"
             variant="outline"
           ></app-custom-dropdown>
           
            <!-- Monthly options checkboxes - directly under frequency input -->
            <div [class.hidden]="newRecurringTransaction.recurringPattern!.frequency !== RecurrenceFrequency.MONTHLY" class="mt-2 space-y-3">
              <div class="flex items-center space-x-4">
                <label class="flex items-center cursor-pointer">
                  <input
                    type="checkbox"
                    [checked]="newRecurringTransaction.recurringPattern!.lastDayOfMonth ?? false"
                    (change)="onLastDayOptionChange('lastDay', $event)"
                    class="w-4 h-4 text-teal-600 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-500 rounded focus:ring-teal-500 dark:focus:ring-teal-600 focus:ring-2 mr-2"
                  >
                  <span class="text-sm text-gray-700 dark:text-gray-300">Last day</span>
                </label>
                <label class="flex items-center cursor-pointer">
                  <input
                    type="checkbox"
                    [checked]="newRecurringTransaction.recurringPattern!.lastWeekdayOfMonth ?? false"
                    (change)="onLastDayOptionChange('lastWeekday', $event)"
                    class="w-4 h-4 text-teal-600 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-500 rounded focus:ring-teal-500 dark:focus:ring-teal-600 focus:ring-2 mr-2"
                  >
                  <span class="text-sm text-gray-700 dark:text-gray-300">Last weekday</span>
                </label>
              </div>
            </div>
         </div>
       </div>

       <!-- Submit button -->
       <div class="flex justify-end pt-4">
         <button
           (click)="addRecurringTransaction()"
           class="px-6 py-2 bg-teal-600 hover:bg-teal-700 text-white font-medium rounded-lg focus:ring-2 focus:ring-teal-500 focus:ring-offset-2 shadow-sm hover:shadow-md transition-colors duration-200"
         >
           Add Transaction
         </button>
       </div>
     </div>
   </app-custom-modal>

  <!-- Timeline Items - Conditional View -->
  <div class="flex-1 overflow-y-auto transaction-timeline-scroll">

   <!-- Grid View (Current Calendar Layout) -->
   <div [class.hidden]="viewMode !== 'grid'" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-2 grid-aligned-with-toggle">
    <div *ngFor="let group of getGroupedTransactions()" class="border border-gray-200 dark:border-chatgpt-border rounded-md overflow-hidden bg-white dark:bg-chatgpt-darker hover:shadow-md">
     <!-- Date Header - More Compact -->
     <div class="bg-gray-100 dark:bg-chatgpt-light px-2 py-1 border-b border-gray-200 dark:border-chatgpt-border">
      <div class="flex items-center justify-between">
       <!-- Left: Month -->
       <div class="text-xs font-medium text-gray-500 dark:text-gray-400 leading-none">
        {{ group.date | date:'MMM' }}
       </div>
       <!-- Center: Date & Day -->
       <div class="text-center">
        <div class="font-bold text-teal-600 dark:text-teal-400 text-sm leading-none">{{ group.date | date:'d' }}</div>
        <div class="font-medium text-gray-600 dark:text-gray-300 text-xs leading-none">{{ group.date | date:'EEE' }}</div>
       </div>
       <!-- Right: Spacer for balance -->
       <div class="text-xs w-8"></div>
      </div>
     </div>

     <!-- Transactions in this date card - More Compact -->
     <div class="p-1.5 space-y-1 min-h-[60px] max-h-[80px] overflow-y-auto">
      <div *ngFor="let transaction of group.transactions"
         class="group rounded px-1.5 py-1 hover:bg-gray-50 dark:hover:bg-gray-800/50 ">

       <!-- Single Line Layout -->
       <div class="flex items-center justify-between">
        <!-- Left: Description -->
        <div class="flex-1 min-w-0">
         <div class="font-medium text-gray-900 dark:text-gray-100 truncate text-xs leading-tight">{{ transaction.description }}</div>
        </div>

        <!-- Right: Amount + Delete -->
        <div class="flex items-center space-x-1 flex-shrink-0">
         <div class="font-medium text-xs" [ngClass]="{
          'text-red-600 dark:text-red-400': transaction.type === TransactionType.EXPENSE,
          'text-green-600 dark:text-green-400': transaction.type === TransactionType.INCOME
         }">
          {{ transaction.type === TransactionType.EXPENSE ? '-' : '+' }}${{ transaction.amount | number:'1.0-0' }}
         </div>
         <button
          (click)="deleteTransaction(transaction.id)"
          class="opacity-0 group-hover:opacity-100 text-gray-400 hover:text-red-500 w-3 h-3 flex items-center justify-center"
          title="Delete"
         >
          Ã—
         </button>
        </div>
       </div>
      </div>

      <!-- Empty state for cards with no transactions -->
      <div *ngIf="group.transactions.length === 0" class="text-center py-2 text-gray-400 dark:text-gray-500 text-xs">
       No transactions
      </div>
     </div>
    </div>
   </div>

   <!-- List View (New Compact Layout) -->
   <div [class.hidden]="viewMode !== 'list'" class="border border-gray-200 dark:border-chatgpt-border rounded-lg overflow-hidden flex flex-col h-full">
    <!-- Fixed Header Row -->
    <div class="bg-gray-100 dark:bg-chatgpt-light px-4 py-2 border-b border-gray-200 dark:border-chatgpt-border">
     <div class="flex items-center justify-between text-xs font-medium text-gray-600 dark:text-gray-400">
      <div class="flex-1">Description</div>
      <div class="w-20 text-center">Date</div>
      <div class="w-24 text-center">Category</div>
      <div class="w-20 text-right">Amount</div>
      <div class="w-16 text-center">Frequency</div>
      <div class="w-8"></div>
     </div>
    </div>

    <!-- Scrollable Transaction Rows Container -->
    <div class="flex-1 overflow-y-auto">
     <div>
      <div *ngFor="let group of getGroupedTransactions(); let groupIndex = index">
       <div *ngFor="let transaction of group.transactions; let transactionIndex = index"
          class="px-4 py-1.5 group"
          [class.bg-white]="isEvenRow(groupIndex, transactionIndex)"
          [class.bg-gray-50]="!isEvenRow(groupIndex, transactionIndex)"
          [class.dark:bg-chatgpt-darker]="isEvenRow(groupIndex, transactionIndex)"
          [class.dark:bg-chatgpt-light]="!isEvenRow(groupIndex, transactionIndex)"
          [class.hover:bg-gray-100]="isEvenRow(groupIndex, transactionIndex)"
          [class.hover:bg-gray-200]="!isEvenRow(groupIndex, transactionIndex)"
          [class.dark:hover:bg-gray-800]="isEvenRow(groupIndex, transactionIndex)"
          [class.dark:hover:bg-gray-700]="!isEvenRow(groupIndex, transactionIndex)">
        <div class="flex items-center justify-between">

         <!-- Description -->
         <div class="flex-1 min-w-0">
          <div class="font-medium text-gray-900 dark:text-gray-100 truncate text-sm leading-tight">
           {{ transaction.description }}
          </div>
         </div>

         <!-- Date -->
         <div class="w-20 text-center">
          <div class="text-xs text-gray-500 dark:text-gray-400">
           {{ transaction.date | date:'MMM d' }}
          </div>
         </div>

         <!-- Category -->
         <div class="w-24 text-center">
          <span class="inline-flex items-center px-1.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300">
           {{ transaction.category }}
          </span>
         </div>

         <!-- Amount -->
         <div class="w-20 text-right">
          <div class="font-semibold text-sm" [ngClass]="{
           'text-red-600 dark:text-red-400': transaction.type === TransactionType.EXPENSE,
           'text-green-600 dark:text-green-400': transaction.type === TransactionType.INCOME
          }">
           {{ transaction.type === TransactionType.EXPENSE ? '-' : '+' }}${{ transaction.amount | number:'1.0-0' }}
          </div>
         </div>

         <!-- Frequency -->
         <div class="w-16 text-center">
          <div class="text-xs text-gray-500 dark:text-gray-400 capitalize">
           {{ transaction.recurringPattern?.frequency?.toLowerCase() || 'Once' }}
          </div>
         </div>

         <!-- Delete Button -->
         <div class="w-8 flex justify-center">
          <button
           (click)="deleteTransaction(transaction.id)"
           class="opacity-0 group-hover:opacity-100 w-5 h-5 flex items-center justify-center text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded "
           title="Delete Transaction"
          >
           <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
           </svg>
          </button>
         </div>

        </div>
       </div>
      </div>
     </div>
    </div>
   </div>

   <!-- Empty State -->
   <div *ngIf="timeline.length === 0" class="text-center py-8">
    <div class="text-gray-500 dark:text-chatgpt-textSecondary">
     No transactions yet. Add some recurring transactions to see your timeline!
    </div>
   </div>
  </div>
 </div>

 <!-- Bottom Row: Balance Projection Chart (Full Width) -->
 <div class="mt-3">
  <app-balance-projection-chart
   [timeline]="timeline"
   [projectionInterval]="projectionInterval"
   [currentBalance]="currentBalance"
   (intervalChange)="onProjectionIntervalChange($event)">
  </app-balance-projection-chart>
 </div>
</div>
